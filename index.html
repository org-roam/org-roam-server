<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Org Roam Server</title>
    <link rel="stylesheet" href="assets/bootstrap.min.css">
    <link rel="stylesheet" href="assets/bootstrap-toggle.min.css">
    <link rel="stylesheet" href="assets/select2.min.css">
    <script type="text/javascript" src="assets/jquery-3.5.0.min.js"></script>
    <script type="text/javascript" src="assets/vis-network.min.js"></script>
    <script type="text/javascript" src="assets/bootstrap.min.js"></script>
    <script type="text/javascript" src="assets/select2.min.js"></script>
    <script type="text/javascript" src="assets/bootstrap-toggle.min.js"></script>

    <style type="text/css">
      * { padding: 0; margin: 0; }
      html, body {
          min-height: 100% !important;
          height: 100%;
          width: 100%;
          overflow: hidden;
          position: relative;
          z-index: 0;
      }

      #global-network, #buffer-network {
          min-height: 100% !important;
          height: 100%;
          width: 100%;
          overflow: hidden;
          position: relative;
          z-index: 4;
          color: #c7cec6 !important;
      }

      #temp-network {
          display: none;
      }

      #preview-frame{
          display: none;
          position: absolute;
          z-index: 100;
      }

      #fileframe {
          display: none;
          position: absolute;
          z-index: 100;
      }

      #iframe-buttons {
          position: absolute;
          z-index: 101;
      }

      #back-button,
      #edit-button,
      #refresh-button {
          display: inline-block;
          z-index: 102;
      }

      #view-menu {
          position: absolute;
          right: 0;
          z-index: 5;
      }

      #dropdownfiles {
          display: none;
          position: absolute;
          width: 25%;
          z-index: 5;
      }

      #controls {
          position: fixed;
          bottom: 0;
          left: 0;
          right: 0;
          max-height: 40px;
          display: flex;
          z-index: 5;
      }

      #dropdownnodes, #dropdownfilters {
          display: none;
          align-self: flex-start;
          width: 25%;
      }

      #formdistance {
          display: none;
          align-self: flex-start;
          margin-left: 10px;
      }

      #formdistance label {
          margin-bottom: 0;
      }

      #inputdistance {
          width: 50px;
      }

      .darkmode #inputdistance {
          color: #c7cec6;
          background-color: #1d1e20;
      }

      #reload-button {
          margin-left: auto;
      }

      #toggle-list-type-button {
          margin-right: auto;
      }

      #toggle-preview {
          position: relative;
          float: left;
          width: %50
      }

      #debug-button {
          display: none;
          position: absolute;
          left:    0;
          bottom:   0;
          z-index: 5;
      }

      #colormode {
          position: absolute;
          display: inline-block;
          left: 50%;
          z-index: 5;
      }

      .select2-container--default .select2-selection--single,
      .select2-container--default .select2-selection--multiple,
      #inputdistance, #colormode, html, body {
          -webkit-transition: background-color 500ms ease-out;
          -moz-transition: background-color 500ms ease-out;
          -o-transition: background-color 500ms ease-out;
          transition: background-color 500ms ease-out;
      }

      .darkmode .select2-container--default .select2-selection--single,
      .darkmode .select2-container--default .select2-selection--multiple,
      .darkmode .select2-search--dropdown,
      .darkmode .select2-results,
      .darkmode
          .select2-container--default
          .select2-selection--multiple
          .select2-selection__choice {
          background-color: #1d1e20;
      }

      .darkmode .select2-search__field {
          background-color: #1d1e20;
          color: #c7cec6 ;
      }
    </style>
  </head>

  <body>
    <div id="dropdownfiles">
      <select class="dropdownfiles" name="files" style="width: 100%;">
        <option></option>
      </select>
    </div>
    <div class="box" id="preview-frame">
      <button class="btn btn-link float-left"
              id="back-button"
              onclick="history.back()"> Back </button>
      <iframe src="" id="hovernode">
      </iframe>
    </div>

    <label class="checkbox-inline" id="colormode">
      <input type="checkbox" data-toggle="toggle"
             data-on="Light Mode" data-off="Dark Mode"
             data-onstyle="default" data-offstyle="default"
             data-size="small" id="colormode-checkbox">
    </label>

    <div class="btn-group btn-group-toggle float-right"
         data-toggle="buttons" id="view-menu">
      <label class="btn btn-sm btn-primary btn-simple active" id="globalview">
        <input type="radio" name="views" checked id="global" value="global">
        <span class="d-none d-sm-block d-md-block
                     d-lg-block d-xl-block">Database Network</span>
      </label>
      <label class="btn btn-sm btn-primary btn-simple" id="bufferview">
        <input type="radio" class="d-none d-sm-none" name="views"
               id="buffer" value="buffer">
        <span class="d-none d-sm-block d-md-block
                     d-lg-block d-xl-block">Buffer Network</span>
      </label>
      <label class="btn btn-sm btn-primary btn-simple" id="fileview">
        <input type="radio" class="d-none d-sm-none" name="views"
               id="files" value="files">
        <span class="d-none d-sm-block d-md-block
                     d-lg-block d-xl-block">File Viewer</span>
      </label>
    </div>

    <button class="btn btn-sm btn-primary btn-simple" id="toggle-preview">
      Enable Preview
    </button>

    <div id="controls">
      <div id="dropdownfilters">
        <select class="dropdownfilters" name="tags"
                multiple="multiple" style="width: 100%;">
          <option></option>
        </select>
      </div>
      <div id="dropdownnodes">
        <select class="dropdownnodes" name="nodes" style="width: 100%;">
          <option></option>
        </select>
      </div>
      <div id="formdistance">
        <label for="distance">Distance: </label>
        <input id="inputdistance" name="distance"
               type="number" value="1" min="0" pattern="\d+" />
      </div>
      <button class="btn btn-primary btn-danger btn-sm" id="toggle-list-type-button">
        Exclude
      </button>
      <button class="btn btn-primary btn-danger btn-sm" id="reload-button">
        Reload
      </button>
    </div>

    <button class="btn btn-primary btn-danger btn-sm" id="debug-button">
      Debug
    </button>

    <div id="global-network"></div>
    <div id="buffer-network"></div>
    <div id="temp-network"></div>
    <div class="fileframe" id="fileframe">
      <div id="iframe-buttons">
        <button class="btn btn-link float-left" id="back-button">Back</button>
        <button class="btn btn-link" id="edit-button">Edit</button>
        <button class="btn btn-link" id="refresh-button">Refresh</button>
      </div>
      <iframe src="" id="filenode"></iframe>
      <iframe src="" id="backlinks"></iframe>
    </div>

    <script type="text/javascript">

      // Maximum of an array given compare function
      Array.prototype.max = function(compare) {
          if (this.length === 0) return null;
          if (this.length === 1) return this[0];
          compare = (compare || Math.max);
          let v = this[0];
          for (let i = 1; i < this.length; i++) {
              let ret = compare(this[i], v);
              if (ret > 0) {
                  v = this[i];
              }
          }
          return v;
      }

      const urlParams = new URLSearchParams(window.location.search);
      const token = urlParams.get('token');

      $(window).on("load", function () {
          var customNetworkOptions = {}
          $.ajax({
              async: false,
              type: 'GET',
              url: `/network-vis-options?token=${token}`,
              success: function(data) {
                  customNetworkOptions = data;
              }
          });

          $.ajax({
              async: false,
              type: 'GET',
              url: `/server-css?token=${token}`,
              success: function(data) {
                  var style = document.createElement('style');
                  style.type = 'text/css';
                  style.innerHTML = data;
                  document.getElementsByTagName('head')[0].appendChild(style);
              }
          });

          var includeFilters = new Set();
          var excludeFilters = new Set();
          const FilterEnum = Object.freeze({"exclude":0, "include":1})
          const filters = [excludeFilters, includeFilters];
          let filterState = FilterEnum.exclude;
          var defaultIncludeFilters = [];
          var defaultExcludeFilters = [];
          const filterButtonTitles = ['Exclude', 'Include'];
          const filterButtonColors = ['#c82333', 'green'];

          $.ajax({
              async: false,
              type: 'GET',
              url: `/default-filters?token=${token}`,
              success: function(data) {
                  if (data.include) {
                      for (let i = 0; i < data.include.length; i++) {
                          filters[FilterEnum.include]
                              .add(JSON.stringify(data.include[i]));
                          defaultIncludeFilters.push(data.include[i].id);
                      }
                  }
                  if (data.exclude) {
                      for (let i = 0; i < data.exclude.length; i++) {
                          filters[FilterEnum.exclude]
                              .add(JSON.stringify(data.exclude[i]));
                          defaultExcludeFilters.push(data.exclude[i].id);
                      }
                  }
              }
          });

          var previewFrame = document.getElementById("preview-frame"); // div
          var hoverNode = document.getElementById("hovernode"); // iframe
          var globalNetwork;
          var bufferNetwork;

          let transformString =
              `translateX(25px)`+
              `translateY(${($("#view-menu").height() + 50)/2}px)`;
          $("#fileframe").css("webkitTransform", transformString);
          $("#fileframe").css("MozTransform", transformString);
          $("#fileframe").css("msTransform", transformString);
          $("#fileframe").css("OTransform", transformString);
          $("#fileframe").css("transform", transformString);

          $("#fileframe #back-button")
              .on("click", function iframeGoBack() {
                  if (darkmode) {
                      // Hide iframes until the page is loaded
                      // to prevent flickering
                      $("#fileframe").css("display", "none");
                  }
                  window.history.back();
              });

          $("#fileframe #edit-button")
              .on("click", function () {
                  const url = new URL(document.getElementById("filenode")
                                      .contentWindow.location.href);
                  let string = url.pathname.substring(
                      1, url.pathname.lastIndexOf('.'));
                  for (let i = 0; i < select2Data.length; i++) {
                      if (select2Data[i].id === string) {
                          window.open("org-protocol://roam-file?file="
                                      .concat(encodeURIComponent(select2Data[i].path)),
                                      "_self");
                          break
                      }
                  }
              });

          $("#fileframe #refresh-button")
              .on("click", function () {
                  if (darkmode) {
                      // Hide iframes until the page is loaded
                      // to prevent flickering
                      $("#fileframe").css("display", "none");
                  }
                  const url = document.getElementById("filenode")
                        .contentWindow.location.href;
                  $("#filenode").attr("src", url);
              });

          function onWindowResize () {
              $("#filenode").width(($(window).width() - 50) * 0.7);
              $("#backlinks").width(($(window).width() - 50) * 0.3);
              $("#filenode").height($(window).height() -
                                    $("#view-menu").height() - 50);
              $("#backlinks").height($(window).height() -
                                     $("#view-menu").height() - 50);
          }
          onWindowResize();
          window.onresize = onWindowResize;

          $("#toggle-preview").css("display", "block");
          $("#dropdownfiles").css("display", "none");
          $("#dropdownnodes").css("display", "none");
          $("#formdistance").css("display", "none");
          $("#dropdownfilters").css("display", "block");
          $("#fileframe").css("display", "none");
          $("#global-network").css("display", "block");
          $("#buffer-network").css("display", "none");

          $("#preview-frame").hover(
              function () {previewFrame.style.display = "block";},
              function () {previewFrame.style.display = "none";});

          var darkmode;
          if (localStorage.darkmode === "true") {
              $('#colormode-checkbox').bootstrapToggle('on')
          } else {
              $('#colormode-checkbox').bootstrapToggle('off')
          }

          $('#colormode-checkbox').change(function() {
              if(this.checked) {
                  $(document.body).addClass("darkmode");
                  document.body.style.backgroundColor = "#1d1e20";
                  document.body.style.color = "#c7cec6";
                  darkmode = true;
                  localStorage.darkmode = true;
                  iframeSetColor("filenode", "#1d1e20", "#c7cec6");
                  iframeSetColor("backlinks", "#1d1e20", "#c7cec6");
                  globalNetwork.setOptions({nodes: {font: { color: "#c7cec6" }}});
                  if ($("#buffer-network").css("display") === "block") {
                      bufferNetwork.setOptions({nodes: {font: { color: "#c7cec6" }}});
                  }
              } else {
                  $(document.body).removeClass("darkmode");
                  document.body.style.backgroundColor = "white";
                  document.body.style.color = "black";
                  darkmode = false;
                  localStorage.darkmode = false;
                  iframeSetColor("filenode", "white", "black");
                  iframeSetColor("backlinks", "white", "black");
                  globalNetwork.setOptions({nodes: {font: { color: "black" }}});
                  if ($("#buffer-network").css("display") === "block") {
                      bufferNetwork.setOptions({nodes: {font: { color: "black" }}});
                  }
              }
          })

          // Visjs network options
          var options = $.extend(true, {
              nodes: {shape: "dot"},
              interaction: {hover: true},
              layout: {improvedLayout: true}
          }, customNetworkOptions);

          var tags;

          // Initialize the network
          // Any update to the dataset objects will update the Network
          var nodeDataset = new vis.DataSet();
          var edgeDataset = new vis.DataSet();

          var filterColors = new Array();
          var view = new vis.DataView(nodeDataset, {
              filter: function (item) {
                  let parsed_filter;
                  for (let i = 0; i < filters.length; i++) {
                      if (filters[i].size > 0) {
                          if (item.tags) {
                              let itemTags = new Set(item.tags);
                              for (let filter of filters[i].values()) {
                                  parsed_filter = JSON.parse(filter);
                                  if (parsed_filter.parent === "tags"){
                                      if ((i == FilterEnum.include ^
                                           itemTags.has(parsed_filter.id))) {
                                          return false;
                                      }
                                  }
                              }
                          } else {
                              if (i == FilterEnum.include) {
                                  return false;
                              }
                          }
                      }
                  }
                  return true;
              }
          });

          globalNetwork = new vis.Network(document.getElementById("global-network"),
                                          {nodes: view,
                                           edges: edgeDataset},
                                          options);

          var tempNetwork = new vis.Network(document.getElementById("temp-network"),
                                            {nodes: nodeDataset,
                                             edges: edgeDataset},
                                            {layout:{improvedLayout: false},
                                             physics:{enabled: false}});

          globalNetwork.on("stabilized", onStabilized);
          globalNetwork.on("selectNode", onNodeClick);
          globalNetwork.on("hoverNode", onNodeHover);
          globalNetwork.on("blurNode", onNodeBlur);

          $('#colormode-checkbox').change()

          function onStabilized () {
              // Update positions storage
              let networkPositions = globalNetwork.getPositions();
              if (!jQuery.isEmptyObject(networkPositions)) {
                  localStorage.positions = JSON.stringify(networkPositions);
              }
          }

          var currentNode;
          var preview = false;

          var currentBuffer;
          var oldCurrentBufferData = "";
          function setCurrentBufferSource () {
              currentBuffer = new EventSource(`/current-buffer-data?token=${token}`);
              currentBuffer.onmessage = function (event) {
                  if (oldCurrentBufferData !== event.data) {
                      currentNode = event.data;
                      oldCurrentBufferData = event.data;
                      if ($("#buffer-network").css("display") === "block") {
                          drawBufferNetwork();
                      }
                  }
              }
          }
          setCurrentBufferSource();

          function debugFunction() {
          }

          $("#debug-button").click(function() {
              debugFunction();
          });

          var roamData;
          var roamSource;
          function reload() {
              $.get(`/roam-data?force=1&token=${token}`, function(data, status){
                  console.log(`Connection to /roam-data: ${status}`);
                  roamData = JSON.parse(data.substring(data.indexOf(':') + 1));
                  update();

                  roamSource = new EventSource(`/roam-data?token=${token}`);
                  roamSource.onmessage = function (event) {
                      roamData = JSON.parse(event.data);
                      update();
                  }
              });
          }
          reload();

          $("#reload-button").click(function() {
              roamSource.close()
              reload();
              currentBuffer.close()
              setCurrentBufferSource();
          });

          $("#toggle-list-type-button").click(function() {
              filterState = (filterState + 1) % filters.length;
              $(this).css('background', filterButtonColors[filterState]);
              $(this).text(filterButtonTitles[filterState]);
          });

          function update () {
              updateNodesAndEdges();
              updateDropdown();

              if ($("#buffer-network").css("display") === "block") {
                  if (currentNode) {
                      drawBufferNetwork();
                  }
              }
          }

          function iframeSetColor(id, background, color) {
              let iframe = document.getElementById(id).contentDocument.body;
              let transition = "background-color 500ms ease-out"
              iframe.style.webkitTransition = transition;
              iframe.style.MozTransition = transition;
              iframe.style.msTransition = transition;
              iframe.style.OTransition = transition;
              iframe.style.transition = transition;
              iframe.style.backgroundColor  = background;

              iframe.style.color = color;
              let h1s = document.getElementById(id)
                  .contentDocument.getElementsByTagName("h1");
              for (let i = 0; i < h1s.length; i++) {
                  h1s[i].style.color = color;
              }
          }

          var select2Data = [];
          function updateDropdown() {
              select2Data = [];
              for (let i = 0 ; i < roamData.nodes.length; i++) {
                  select2Data.push({id: roamData.nodes[i].id,
                                    text: roamData.nodes[i].title,
                                    path: roamData.nodes[i].path})
              }

              // Node search dropdown (Buffer Network View)
              $(".dropdownnodes")
                  .select2({
                      data: select2Data,
                      placeholder: 'Node',
                      width: 'resolve'
                  })
                  .on('select2:select', function (e) {
                      currentNode = e.params.data.id;
                      drawBufferNetwork();
                  });

              // File search dropdown (File Viewer)
              $(".dropdownfiles")
                  .select2({
                      data: select2Data,
                      placeholder: 'File',
                      width: 'resolve'
                  })
                  .on('select2:select', function (e) {
                      if (darkmode) {
                          // Hide iframes until the page is loaded
                          // to prevent flickering
                          $("#fileframe").css("display", "none");
                      }
                      $("#filenode")
                          .attr("src", e.params.data.id.concat(`.html?token=${token}`));
                  });

              let select2Filters = [{id: "tags", text: "Tags", children: []}];
              tags.forEach(function (tag) {
                  select2Filters[0].children.push({id: tag,
                                                   text: tag,
                                                   parent: "tags"})
              });

              $(".dropdownfilters").html(""); // To prevent duplicate tags
              let s2filters = $(".dropdownfilters")
                  .select2({
                      data: select2Filters,
                      placeholder: "Filter",
                      width: 'resolve',
                      templateSelection: function (data, container) {
                          if(!filterColors[data.id]) {
                              const color = $('#toggle-list-type-button').
                                    css("backgroundColor");
                              $(container).css("background-color", color);
                              filterColors[data.id] = color;
                          } else {
                              $(container).css("background-color",
                                               filterColors[data.id]);
                          }
                          return data.text;
                      }
                  })
                  .on('select2:select', function (e) {
                      filters[filterState].add(JSON.stringify(
                          {id: e.params.data.id, parent: e.params.data.parent}));
                      view.refresh()
                  })
                  .on('select2:unselect', function (e) {
                      for (let i = 0; i < filters.length; i++) {
                          filters[i].delete(
                              JSON.stringify({id: e.params.data.id,
                                              parent: e.params.data.parent}));
                      }

                      //maintain color map
                      filterColors[e.params.data.id] = null;
                      view.refresh()
                  });

              for (let i = 0; i < defaultIncludeFilters.length; i++) {
                  filterColors[defaultIncludeFilters[i]] =
                      filterButtonColors[FilterEnum.include];
              }
              for (let i = 0; i < defaultExcludeFilters.length; i++) {
                  filterColors[defaultExcludeFilters[i]] =
                      filterButtonColors[FilterEnum.exclude];
              }
              s2filters.val(defaultIncludeFilters.concat(defaultExcludeFilters))
                  .trigger('change');

              $("#filenode").on("load", function () {
                  let string = document.getElementById("filenode")
                      .contentWindow.location.href;
                  string = string.substring(string.lastIndexOf('/') + 1);
                  string = string.substring(0, string.lastIndexOf('.'));
                  let link;
                  for (let i = 0; i < select2Data.length; i++) {
                      // handle the URLs of select2Data[i] with parent directories
                      let selstr = select2Data[i].id;
                      selstr = selstr.substring(selstr.lastIndexOf('/')+1);
                      if (selstr === string) {
                          link = `org-roam-buffer?path=${select2Data[i].path}&` +
                              `label=${select2Data[i].text}&token=${token}`;
                          break
                      }
                  }

                  const links = document.getElementById("filenode")
                        .contentWindow.document.getElementsByTagName("a");
                  for (let i = 0; i < links.length; i++) {
                      links[i].onclick = function () {
                          if (darkmode) {
                              // Hide iframes until the page is loaded
                              // to prevent flickering
                              $("#fileframe").css("display", "none");
                          }
                      }
                  }

                  $("#backlinks").attr("src", link);
                  $('#backlinks').on('load', function() {
                      const links = document.getElementById("backlinks")
                            .contentWindow.document.getElementsByName("backlink");
                      let url;
                      let base_location;
                      for (let i = 0; i < links.length; i++) {
                          links[i].onclick = function () {
                              url = this.id.substring(0, this.id.lastIndexOf('.'));
                              url = url.concat(".html");
                              base_location = document.getElementById("filenode")
                                  .contentWindow.location;
                              url = `${base_location.protocol}//`+
                                  `${base_location.host}/`+
                                  `${url}?token=${token}`
                              if (darkmode) {
                                  // Hide iframes until the page is loaded
                                  // to prevent flickering
                                  $("#fileframe").css("display", "none");
                              }
                              $("#filenode").attr("src", url);
                          }
                      }
                      if (darkmode) {
                          iframeSetColor("filenode", "#1d1e20", "#c7cec6");
                          iframeSetColor("backlinks", "#1d1e20", "#c7cec6");
                          $("#fileframe").css("display", "block");
                      } else {
                          iframeSetColor("filenode", "white", "black");
                          iframeSetColor("backlinks", "white", "black");
                      }
                  });
              });
          }

          $("#globalview").click(function() {
              $("#toggle-preview").css("display", "block");
              $("#dropdownfiles").css("display", "none");
              $("#dropdownfilters").css("display", "block");
              $("#fileframe").css("display", "none");
              $("#dropdownnodes").css("display", "none");
              $("#formdistance").css("display", "none");
              $("#global-network").css("display", "block");
              $("#buffer-network").css("display", "none");
              $("#toggle-list-type-button").css("display", "block");
          });
          $("#bufferview").click(function() {
              $("#toggle-preview").css("display", "block");
              $("#dropdownfiles").css("display", "none");
              $("#dropdownfilters").css("display", "none");
              $("#dropdownnodes").css("display", "block");
              $("#formdistance").css("display", "block");
              $("#fileframe").css("display", "none");
              $("#global-network").css("display", "none");
              $("#buffer-network").css("display", "block");
              $("#toggle-list-type-button").css("display", "none");
              if (currentNode) {
                  drawBufferNetwork();
              }
          });
          $("#fileview").click(function() {
              $("#global-network").css("display", "none");
              $("#buffer-network").css("display", "none");
              $("#toggle-preview").css("display", "none");
              $("#dropdownnodes").css("display", "none");
              $("#formdistance").css("display", "none");
              $("#dropdownfiles").css("display", "block");
              $("#dropdownfilters").css("display", "none");
              $("#fileframe").css("display", "block");
              $("#toggle-list-type-button").css("display", "none");
          });
          $("#toggle-preview").click(function() {
              if (preview) {
                  preview = false;
                  $("#toggle-preview").text("Enable Preview");
              } else {
                  preview = true;
                  $("#toggle-preview").text("Disable Preview");
              }
          });
          $("#inputdistance").on("input", drawBufferNetwork);

          function updateNodesAndEdges () {
              const tempDataset = new vis.DataSet(roamData.nodes);
              nodeDataset.update(roamData.nodes);
              edgeDataset.clear();
              edgeDataset.update(roamData.edges);
              const nodes = tempDataset.get({returnType:"Object"});
              if (localStorage.positions &&
                  !jQuery.isEmptyObject(localStorage.positions)) {
                  let structuredPositions = []
                  const positions = JSON.parse(localStorage.positions);
                  for (let key in positions) {
                      if (Object.prototype.hasOwnProperty.call(positions, key)) {
                          if (nodes[key]) { // Check if it is removed from the database
                              structuredPositions.push({id: key,
                                                        x: positions[key].x,
                                                        y: positions[key].y});
                          } else {
                              nodeDataset.remove(key);
                          }
                      }
                  }
                  nodeDataset.update(structuredPositions);
              }

              // Set value depending on the number of connected nodes
              // Also construct a set of tags
              tags = new Set();
              for (let nodeId in nodes) {
                  if (nodes[nodeId].tags) {
                      for (let i = 0; i < nodes[nodeId].tags.length; i++ ) {
                          tags.add(nodes[nodeId].tags[i]);
                      }
                  }
                  if (!nodes[nodeId].value) {
                      nodes[nodeId].value = tempNetwork.getConnectedNodes(nodeId).length;
                  }
              }

              function compareNodeValues(nodeId1, nodeId2) {
                  return nodes[nodeId1].value - nodes[nodeId2].value;
              }

              // Group the nodes
              let group = 0;
              const keys = Object.keys(nodes).sort(compareNodeValues);
              for (let i = 0; i < keys.length; i++) {
                  const k = keys[i];
                  if (!nodes[k].group) {
                      const connectedNodes = tempNetwork.getConnectedNodes(k);
                      if (connectedNodes.length > 0) {
                          const node = connectedNodes.max(compareNodeValues);
                          if (!nodes[node].group) {
                              nodes[node].group = group;
                              group += 1;
                          }
                          nodes[k].group = nodes[node].group;
                      } else {
                          nodes[k].group = group;
                          group += 1;
                      }
                  }
              }

              // Update the dataset
              let updateArray = [];
              for (let nodeId in nodes) {
                  if (Object.prototype.hasOwnProperty.call(nodes, nodeId)) {
                      updateArray.push(nodes[nodeId]);
                  }
              }
              nodeDataset.update(updateArray);

              // Keep roamData updated for buffer network
              roamData.nodes = updateArray;
          }

          function onNodeClick(params) {
              if (params.nodes.length === 1) {
                  let node = params.nodes[0];
                  window.open(tempNetwork.body.nodes[node].options.url,
                              "_self");
                  currentNode = node;
                  // If we are in the buffer view, draw new node
                  if ($("#buffer-network").css("display") === "block") {
                      drawBufferNetwork();
                  }
              }
          }

          var nodeHovered = true;
          function onNodeHover(params) {
              if (preview) {
                  nodeHovered = true;
                  hoverNode.src = params.node.concat(`.html?token=${token}`);
                  $('#hovernode').on('load', function() {
                      if (nodeHovered) {
                          let x = params.event.clientX;
                          let y = params.event.clientY;

                          $("#hovernode").width(
                              Math.abs($(window).width()/2 - x) +
                                  $(window).width()/2 - 50);
                          $("#hovernode").height(
                              Math.abs($(window).height()/2 - y) +
                                  $(window).height()/2 - 50);

                          // Check boundaries
                          if ((x + $("#hovernode").width()) > $(window).width()) {
                              x = x - $("#hovernode").width();
                          }
                          if ((y + $("#hovernode").height()) > $(window).height()) {
                              y = y - $("#hovernode").height();
                          }

                          // Move previewFrame to the hovered node's position
                          let transformString =
                              `translateX(${x}px)`+
                              `translateY(${y}px)`;
                          previewFrame.style.webkitTransform = transformString;
                          previewFrame.style.MozTransform = transformString;
                          previewFrame.style.msTransform = transformString;
                          previewFrame.style.OTransform = transformString;
                          previewFrame.style.transform = transformString;

                          if (darkmode) {
                              iframeSetColor("hovernode", "#1d1e20", "#c7cec6");
                          } else {
                              iframeSetColor("hovernode", "white", "black");
                          }

                          previewFrame.style.display = "block";
                      }
                  });
              }
          }

          function onNodeBlur() {
              nodeHovered = false;
              previewFrame.style.display = "none";
          }

          function collectConnectedNodes(
              allNodes, baseNode, distance, alreadyConnected) {
              if (distance < 1) {
                  return new Set([baseNode]); // base case for recursion
              }

              let connectedNodes = new Set([baseNode]);
              const neighbours = tempNetwork.getConnectedNodes(baseNode);

              for (let i = 0; i < neighbours.length; i++) {
                  // Skip this node if we've already seen it. Helps with the performance.
                  if (alreadyConnected && alreadyConnected.has(neighbours[i])) continue;
                  var neighbourConnectedNodes = collectConnectedNodes(
                      allNodes, neighbours[i], distance - 1, connectedNodes);
                  for (let node of neighbourConnectedNodes) {
                      connectedNodes.add(node);
                  }
              }
              return connectedNodes;
          }

          function drawBufferNetwork() {
              const nodeDataset = new vis.DataSet(roamData.nodes);
              const nodes = nodeDataset.get({returnType:"Object"});
              const connectedNodes = Array.from(
                  collectConnectedNodes(
                      nodes,
                      currentNode,
                      parseInt(document.getElementById('inputdistance').value)));
              let bufferNodes = [];
              for (let i = 0; i < connectedNodes.length; i++) {
                  bufferNodes.push(nodes[connectedNodes[i]]);
              }
              const bufferContainer = document.getElementById("buffer-network");
              bufferNetwork = new vis.Network(
                  bufferContainer,
                  {nodes:bufferNodes,
                   edges:roamData.edges},
                  options);
              bufferNetwork.on("selectNode", onNodeClick);
              bufferNetwork.on("hoverNode", onNodeHover);
              bufferNetwork.on("blurNode", onNodeBlur);

              if (darkmode) {
                  bufferNetwork.setOptions({nodes: {font: { color: "#c7cec6" }}});
              } else {
                  bufferNetwork.setOptions({nodes: {font: { color: "black" }}});
              }
          }
      });
    </script>
  </body>
</html>
